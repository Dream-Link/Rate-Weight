<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Weighing Calculator</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Chakra+Petch:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f7fc; --container-bg: #ffffff; --primary-color: #6a5af9;
            --primary-hover: #5042d3; --text-color: #343d4f; --secondary-text-color: #6e7a8e;
            --border-color: #e6e9f0; --display-bg: #23252f;
            --display-text-weight: #81e6d9; --display-text-price: #f6ad55;
            --shadow: 0 8px 32px rgba(106, 90, 249, 0.1); --danger-color: #f74d6c;
            --rounded-radius: 16px; --transition-duration: 0.2s ease-in-out;
        }
        
        /* --- 30+ Themes --- */
        /* Dark Themes */
        .theme-default-dark { --bg-color: #1a202c; --container-bg: #2d3748; --primary-color: #667eea; --text-color: #f7fafc; --secondary-text-color: #a0aec0; --border-color: #4a5568; }
        .theme-ocean { --bg-color: #172c3f; --container-bg: #1e3b58; --primary-color: #2ac9ff; --text-color: #f7fafc; --secondary-text-color: #a0aec0; --border-color: #4a5568; }
        .theme-sunset { --bg-color: #4a148c; --container-bg: #6a1b9a; --primary-color: #ff8a5c; --text-color: #f7fafc; --secondary-text-color: #e0e0e0; --border-color: #7b1fa2; }
        .theme-forest { --bg-color: #2e7d32; --container-bg: #388e3c; --primary-color: #aed581; --text-color: #f7fafc; --secondary-text-color: #e0e0e0; --border-color: #558b2f; }
        .theme-rose { --bg-color: #5d0017; --container-bg: #880e4f; --primary-color: #f06292; --text-color: #f7fafc; --secondary-text-color: #fce4ec; --border-color: #c2185b; }
        .theme-sky { --bg-color: #01579b; --container-bg: #0277bd; --primary-color: #4fc3f7; --text-color: #f7fafc; --secondary-text-color: #e1f5fe; --border-color: #039be5; }
        .theme-mint { --bg-color: #004d40; --container-bg: #00695c; --primary-color: #69f0ae; --text-color: #f7fafc; --secondary-text-color: #e0f2f1; --border-color: #00796b; }
        .theme-lavender { --bg-color: #311b92; --container-bg: #4527a0; --primary-color: #b39ddb; --text-color: #f7fafc; --secondary-text-color: #ede7f6; --border-color: #512da8; }
        .theme-sand { --bg-color: #3e2723; --container-bg: #4e342e; --primary-color: #a1887f; --text-color: #f7fafc; --secondary-text-color: #efebe9; --border-color: #5d4037; }
        .theme-charcoal { --bg-color: #263238; --container-bg: #37474f; --primary-color: #90a4ae; --text-color: #f7fafc; --secondary-text-color: #eceff1; --border-color: #455a64; }
        .theme-wine { --bg-color: #880e4f; --container-bg: #ad1457; --primary-color: #ec407a; --text-color: #f7fafc; --secondary-text-color: #fce4ec; --border-color: #c2185b; }

        /* Light Themes */
        .theme-light-blue { background: #e3f2fd; --container-bg: #fff; --primary-color: #1976d2; --text-color: #212121; --secondary-text-color: #757575; --border-color: #e0e0e0; }
        .theme-light-green { background: #e8f5e9; --container-bg: #fff; --primary-color: #388e3c; --text-color: #212121; --secondary-text-color: #757575; --border-color: #e0e0e0; }
        .theme-light-orange { background: #fff3e0; --container-bg: #fff; --primary-color: #f57c00; --text-color: #212121; --secondary-text-color: #757575; --border-color: #e0e0e0; }
        
        /* Gradient Themes */
        .theme-deep-space { background: linear-gradient(135deg, #000000, #434343); --container-bg: rgba(0,0,0,0.2); --primary-color: #74ebd5; --text-color: #f7fafc;}
        .theme-mango-dream { background: linear-gradient(135deg, #f2994a, #f2c94c); --container-bg: rgba(255,255,255,0.8); --primary-color: #d85d11; --text-color: #333; --secondary-text-color: #555; }
        .theme-pinky-promise { background: linear-gradient(135deg, #ffdde1, #ee9ca7); --container-bg: rgba(255,255,255,0.8); --primary-color: #c43c54; --text-color: #444; --secondary-text-color: #666; }
        .theme-royal-purple { background: linear-gradient(135deg, #5f2c82, #49a09d); --container-bg: rgba(0,0,0,0.2); --primary-color: #a770ef; --text-color: #f7fafc;}
        .theme-bloody-mary { background: linear-gradient(135deg, #ff512f, #dd2476); --container-bg: rgba(0,0,0,0.2); --primary-color: #fff0f5; --text-color: #f7fafc;}

        /* Animated Gradients */
        @keyframes animatedGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .theme-aurora { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: animatedGradient 15s ease infinite; --container-bg: rgba(0,0,0,0.2); --primary-color: #fff; --text-color: #f7fafc;}
        .theme-liquid-metal { background: linear-gradient(-45deg, #d7d2cc, #304352, #d7d2cc, #304352); background-size: 400% 400%; animation: animatedGradient 10s ease infinite; --container-bg: rgba(0,0,0,0.2); --primary-color: #fff; --text-color: #f7fafc;}
        .theme-synthwave { background: linear-gradient(-45deg, #f02fc2, #6094ea, #23a6d5, #23d5ab); background-size: 400% 400%; animation: animatedGradient 18s ease infinite; --container-bg: rgba(0,0,0,0.2); --primary-color: #fff; --text-color: #f7fafc;}
        
        /* 3D Textures */
        .theme-carbon-fiber { background-color: #222; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="28" height="49" viewBox="0 0 28 49"%3E%3Cg fill-rule="evenodd"%3E%3Cg id="hexagons" fill="%23333" fill-opacity="0.4" fill-rule="nonzero"%3E%3Cpath d="M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5l-13 7.5L0 33.5V15z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); --container-bg: #1a1a1a; --primary-color: #08f7fe; --text-color: #f7fafc;}
        .theme-blueprint { background-color: #2a4365; background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" xmlns="http://www.w3.org/2000/svg"%3E%3Cdefs%3E%3Cpattern id="p" width="100" height="100" patternUnits="userSpaceOnUse"%3E%3Cpath d="M0 50V0h50a50 50 0 0 1 0 100H0" fill="none" stroke="%233a5378" stroke-width="2"/%3E%3C/pattern%3E%3C/defs%3E%3Crect width="100%25" height="100%25" fill="url(%23p)"/%3E%3C/svg%3E'); --container-bg: #1a365d; --primary-color: #fff; --text-color: #f7fafc;}
        .theme-wood { background-color: #6B4F35; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"%3E%3Cg fill="%235A422B" fill-opacity="0.4"%3E%3Cpath fill-rule="evenodd" d="M11 0l5 20-5-5-5 5L11 0zm22 21l-5 20 5 5 5-5-5-20zm22 21l5 20-5-5-5 5 5-20zM0 31l5 20-5-5-5 5 5-20zm66 0l5 20-5-5-5 5 5-20zM22 41l-5 20 5 5 5-5-5-20z"/%3E%3C/g%3E%3C/svg%3E'); --container-bg: #4E3629; --primary-color: #D2B48C; --text-color: #f7fafc;}

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-color, linear-gradient(135deg, #1a202c, #283149)); color: var(--text-color, #343d4f); }
        .calculator-container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        @media (min-width: 500px) {
            body { display: flex; justify-content: center; align-items: center; padding: 20px; }
            .calculator-container { background: var(--container-bg, #2d3748); width: 100%; max-width: 450px; min-height: auto; max-height: 95vh; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color, #4a5568); overflow-y: auto; }
        }
        .main-content { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; }
        .header { font-size: 1.5rem; color: var(--primary-color); font-weight: 600; cursor: pointer; }
        .top-bar-actions { display: flex; gap: 10px; }
        .icon-btn { background: transparent; border: none; color: var(--secondary-text-color, #6e7a8e); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all var(--transition-duration); }
        .icon-btn:hover { background-color: var(--primary-color); color: #fff; transform: translateY(-2px); }
        .icon-btn:active { transform: scale(0.9); }
        .display-area { background: var(--display-bg, rgba(26, 32, 44, 0.7)); border-radius: var(--rounded-radius); padding: 20px; margin-bottom: 25px; position: relative; border: 1px solid var(--border-color, #4a5568); backdrop-filter: blur(8px); }
        #resetBtn { position: absolute; top: 10px; right: 10px; }
        .display-area label { display: block; color: var(--secondary-text-color, #6e7a8e); font-size: 0.9rem; margin-bottom: 5px; text-align: left; }
        #mainInput { width: 100%; background: transparent; border: none; font-family: 'Chakra Petch', sans-serif; font-size: 3.5rem; font-weight: 700; text-align: right; outline: none; color: var(--display-text-weight); transition: color 0.4s ease; }
        .display-area.price-mode #mainInput { color: var(--display-text-price); }
        .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; padding: 10px; background: var(--display-bg, rgba(26, 32, 44, 0.7)); border-radius: var(--rounded-radius); border: 1px solid var(--border-color, #4a5568); backdrop-filter: blur(8px); }
        .controls select { flex-grow: 1; padding: 14px; border: none; border-radius: 12px; background-color: transparent; color: var(--text-color); font-size: 1rem; outline: none; -webkit-appearance: none; appearance: none; }
        #interchangeBtn { background-color: rgba(255, 255, 255, 0.1); border-radius: 12px; color: var(--primary-color); }
        .result-area { text-align: center; padding: 20px; background: var(--display-bg, rgba(26, 32, 44, 0.7)); border-radius: var(--rounded-radius); margin-bottom: 25px; border: 1px solid var(--border-color, #4a5568); backdrop-filter: blur(8px); }
        .result-area label { font-size: 1rem; color: var(--secondary-text-color, #6e7a8e); }
        .result-area #priceDisplay { font-size: 3rem; font-weight: 700; color: var(--primary-color); margin-top: 5px; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: auto; }
        .btn { padding: 16px; font-size: 1rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all var(--transition-duration); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn:active { transform: scale(0.96); box-shadow: none; }
        .btn-primary { background: var(--primary-color); color: #fff !important; }
        .btn-secondary { background-color: var(--border-color, #e6e9f0); color: var(--text-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; opacity: 1; }
        .modal-content { background-color: var(--container-bg, #ffffff); color: var(--text-color); border-radius: 20px; border: 1px solid var(--border-color, #e6e9f0); box-shadow: var(--shadow); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { border-bottom: 1px solid var(--border-color, #e6e9f0); padding: 20px 25px 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group label, #productList li span { color: var(--text-color); }
        #productSelect option { background: var(--container-bg, #ffffff); color: var(--text-color); }
        #productList li { background-color: rgba(0,0,0,0.1); padding: 10px 15px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        body[class*="light"] #productList li, body:not([class]) #productList li { background-color: rgba(0,0,0,0.05); } /* Light themes list item background */
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 15px; }
        .theme-option { height: 60px; border-radius: 15px; border: 2px solid var(--border-color, #e6e9f0); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: transform 0.15s ease-in-out; cursor: pointer; }
        .pos-style-view { font-family: 'Courier New', monospace; background: var(--container-bg); color: var(--text-color); padding: 20px; border-radius: 12px; font-size: 14px; border: 1px solid var(--border-color); }
        .pos-style-view div { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed var(--border-color); }
        .pos-style-view div:last-child { border-bottom: none; border-top: 1px solid var(--text-color); margin-top: 5px; padding-top: 10px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body class="theme-default-dark">
    <div class="calculator-container">
        <div class="top-bar">
            <h2 class="header" id="headerBtn"><span id="storeName"></span></h2>
            <div class="top-bar-actions">
                <button id="importBtn" class="icon-btn" title="Import"><i class="material-icons-round">file_upload</i></button>
                <button id="exportBtn" class="icon-btn" title="Export"><i class="material-icons-round">file_download</i></button>
                <button id="addProductBtn" class="icon-btn" title="Add Product"><i class="material-icons-round">add_circle</i></button>
                <button id="manageProductsBtn" class="icon-btn" title="Manage Products"><i class="material-icons-round">inventory</i></button>
                <button id="themeBtn" class="icon-btn" title="Change Theme"><i class="material-icons-round">palette</i></button>
            </div>
        </div>
        <div class="main-content">
            <div class="display-area" id="displayArea">
                <button id="resetBtn" class="icon-btn"><i class="material-icons-round">restart_alt</i></button>
                <label id="inputLabel">वज़न (ग्राम में)</label>
                <input type="text" id="mainInput" inputmode="decimal" placeholder="0" pattern="[0-9]*\.?[0-9]*">
            </div>
            <div class="controls">
                <select id="productSelect"></select>
                <button id="interchangeBtn" class="icon-btn"><i class="material-icons-round">swap_horiz</i></button>
            </div>
            <div class="result-area">
                <label id="resultLabel">कुल कीमत</label>
                <div id="priceDisplay">₹0.00</div>
            </div>
            <div class="action-buttons">
                <button id="breakdownBtn" class="btn btn-secondary">विवरण देखें</button>
                <button id="printBtn" class="btn btn-primary">रसीद प्रिंट करें</button>
            </div>
        </div>
    </div>
    
    <div id="productModal" class="modal"></div>
    <div id="manageModal" class="modal"></div>
    <div id="breakdownModal" class="modal"></div>
    <div id="themeModal" class="modal"></div>
    <div id="storeInfoModal" class="modal"></div>
    <div id="receipt" style="display: none;"></div>

    <script>
    class WeighingApp {
        constructor() {
            this.dom = {
                mainInput: document.getElementById('mainInput'), displayArea: document.getElementById('displayArea'),
                storeNameEl: document.getElementById('storeName'), productSelect: document.getElementById('productSelect'),
                priceDisplay: document.getElementById('priceDisplay'), inputLabel: document.getElementById('inputLabel'),
                resultLabel: document.getElementById('resultLabel'), body: document.body,
                modals: { product: document.getElementById('productModal'), manage: document.getElementById('manageModal'), breakdown: document.getElementById('breakdownModal'), theme: document.getElementById('themeModal'), store: document.getElementById('storeInfoModal') }
            };
            this.products = []; this.storeInfo = {}; this.currentMode = 'weightToPrice'; this.nextProductId = 1;
            this.themes = {
                'Default Dark': { class: 'theme-default-dark', color: '#2d3748' }, 'Ocean': { class: 'theme-ocean', color: '#1e3b58' },
                'Sunset': { class: 'theme-sunset', color: '#6a1b9a' }, 'Forest': { class: 'theme-forest', color: '#388e3c' },
                'Rose': { class: 'theme-rose', color: '#880e4f' }, 'Sky': { class: 'theme-sky', color: '#0277bd' },
                'Mint': { class: 'theme-mint', color: '#00695c' }, 'Lavender': { class: 'theme-lavender', color: '#4527a0' },
                'Sand': { class: 'theme-sand', color: '#4e342e' }, 'Charcoal': { class: 'theme-charcoal', color: '#37474f' },
                'Wine': { class: 'theme-wine', color: '#ad1457' }, 'Light Blue': { class: 'theme-light-blue', color: '#1976d2' },
                'Light Green': { class: 'theme-light-green', color: '#388e3c' }, 'Light Orange': { class: 'theme-light-orange', color: '#f57c00' },
                'Deep Space (Grad)': { class: 'theme-deep-space', color: 'linear-gradient(135deg, #000, #434343)' },
                'Mango Dream (Grad)': { class: 'theme-mango-dream', color: 'linear-gradient(135deg, #f2994a, #f2c94c)' },
                'Pinky Promise (Grad)': { class: 'theme-pinky-promise', color: 'linear-gradient(135deg, #ffdde1, #ee9ca7)' },
                'Royal Purple (Grad)': { class: 'theme-royal-purple', color: 'linear-gradient(135deg, #5f2c82, #49a09d)' },
                'Bloody Mary (Grad)': { class: 'theme-bloody-mary', color: 'linear-gradient(135deg, #ff512f, #dd2476)' },
                'Aurora (Anim)': { class: 'theme-aurora', color: 'linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)' },
                'Liquid Metal (Anim)': { class: 'theme-liquid-metal', color: 'linear-gradient(-45deg, #d7d2cc, #304352)' },
                'Synthwave (Anim)': { class: 'theme-synthwave', color: 'linear-gradient(-45deg, #f02fc2, #6094ea)' },
                'Carbon Fiber (3D)': { class: 'theme-carbon-fiber', color: '#1a1a1a' },
                'Blueprint (3D)': { class: 'theme-blueprint', color: '#1a365d' },
                'Wood (3D)': { class: 'theme-wood', color: '#4E3629' }
            };
            this.init();
        }

        init() { this.injectModalHTML(); this.attachEventListeners(); this.loadStoreInfo(); this.loadProducts(); this.populateProductSelect(); this.applyTheme(); this.calculate(); }
        
        attachEventListeners() {
            document.getElementById('headerBtn').addEventListener('click', () => this.openStoreInfoModal());
            document.getElementById('addProductBtn').addEventListener('click', () => this.openAddProductModal());
            document.getElementById('manageProductsBtn').addEventListener('click', () => this.openManageModal());
            document.getElementById('themeBtn').addEventListener('click', () => this.openThemeModal());
            document.getElementById('importBtn').addEventListener('click', () => this.importData());
            document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
            document.getElementById('resetBtn').addEventListener('click', () => this.resetInput());
            document.getElementById('interchangeBtn').addEventListener('click', () => this.toggleMode());
            document.getElementById('breakdownBtn').addEventListener('click', () => this.showBreakdown());
            document.getElementById('printBtn').addEventListener('click', () => this.printReceipt());
            this.dom.mainInput.addEventListener('input', () => this.calculate());
            this.dom.productSelect.addEventListener('change', () => this.calculate());
            Object.values(this.dom.modals).forEach(modal => { modal.addEventListener('click', e => { if (e.target.classList.contains('close-btn') || e.target === modal) this.closeModal(modal); }); });
        }

        injectModalHTML() {
            const createModalContent = (title, body) => `<div class="modal-content"><div class="modal-header"><h2>${title}</h2><span class="close-btn">&times;</span></div><div class="modal-body">${body}</div></div>`;
            this.dom.modals.product.innerHTML = createModalContent('प्रोडक्ट की जानकारी', `<form id="productForm"><input type="hidden" id="productId"><div class="form-group"><label>प्रोडक्ट का नाम</label><input type="text" id="productName" required></div><div class="form-group"><label>मूल्य (₹)</label><input type="number" id="productPrice" required></div><div class="form-group"><label>वज़न यूनिट</label><select id="productUnit"><option value="100">प्रति 100g</option><option value="200">प्रति 200g</option><option value="500">प्रति 500g</option><option value="1000" selected>प्रति 1kg</option></select></div><div class="form-group"><label>कमीशन (वैकल्पिक)</label><div class="discount-group"><input type="number" id="productCommission" placeholder="0"><select id="commissionType"><option value="percent">%</option><option value="manual">₹</option></select></div></div><button type="submit" class="btn btn-primary" style="width:100%;">सेव करें</button></form>`);
            this.dom.modals.manage.innerHTML = createModalContent('प्रोडक्ट मैनेज करें', '<ul id="productList"></ul>');
            this.dom.modals.breakdown.innerHTML = createModalContent('गणना का विवरण', '<div id="breakdownDetails"></div>');
            this.dom.modals.theme.innerHTML = createModalContent('थीम चुनें', '<div id="themeGrid" class="theme-grid"></div>');
            this.dom.modals.store.innerHTML = createModalContent('स्टोर की जानकारी', `<form id="storeInfoForm"><div class="form-group"><label>स्टोर/दुकान का नाम</label><input type="text" id="inputStoreName" required></div><div class="form-group"><label>पता</label><input type="text" id="inputStoreAddress"></div><button type="submit" class="btn btn-primary" style="width:100%;">सेव करें</button></form>`);
            document.getElementById('productForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
            document.getElementById('storeInfoForm').addEventListener('submit', (e) => this.handleStoreInfoSubmit(e));
            document.getElementById('productList').addEventListener('click', (e) => this.handleProductListActions(e));
        }

        applyTheme() { this.dom.body.className = localStorage.getItem('weighingTheme') || 'theme-default-dark'; }
        loadStoreInfo() { this.storeInfo = JSON.parse(localStorage.getItem('storeInfo')) || { name: 'Smart Weigh', address: 'Jaipur, Rajasthan' }; this.dom.storeNameEl.textContent = this.storeInfo.name; }
        handleStoreInfoSubmit(e) { e.preventDefault(); this.storeInfo.name = document.getElementById('inputStoreName').value; this.storeInfo.address = document.getElementById('inputStoreAddress').value; localStorage.setItem('storeInfo', JSON.stringify(this.storeInfo)); this.dom.storeNameEl.textContent = this.storeInfo.name; this.closeModal(this.dom.modals.store); }
        loadProducts() {
            this.products = JSON.parse(localStorage.getItem('weighingProducts')) || [];
            if (this.products.length === 0) {
                this.products = [{ id: 1, name: 'Sugar (चीनी)', price: 45, unit: 1000, commission: 5, commissionType: 'percent' }];
                this.saveProducts();
            }
            this.nextProductId = this.products.length > 0 ? Math.max(...this.products.map(p => p.id)) + 1 : 1;
        }
        saveProducts() { localStorage.setItem('weighingProducts', JSON.stringify(this.products)); }
        openModal(modal) { modal.classList.add('show'); }
        closeModal(modal) { modal.classList.remove('show'); }
        resetInput() { this.dom.mainInput.value = ''; this.calculate(); }
        
        toggleMode() {
            const oldInputValue = parseFloat(this.dom.mainInput.value.replace(/[^0-9.]/g, '')) || 0;
            const oldOutputValue = parseFloat(this.dom.priceDisplay.textContent.replace(/[^0-9.]/g, '')) || 0;
            this.currentMode = (this.currentMode === 'weightToPrice') ? 'priceToWeight' : 'weightToPrice';
            this.dom.displayArea.classList.toggle('price-mode');
            const isWeightMode = this.currentMode === 'weightToPrice';
            this.dom.inputLabel.textContent = isWeightMode ? 'वज़न (ग्राम में)' : 'कीमत (₹ में)';
            this.dom.resultLabel.textContent = isWeightMode ? 'कुल कीमत' : 'कुल वज़न (ग्राम)';
            this.dom.mainInput.value = oldOutputValue > 0 ? oldOutputValue : '';
            this.calculate();
        }

        calculate() {
            const product = this.products.find(p => p.id == this.dom.productSelect.value);
            const value = parseFloat(this.dom.mainInput.value) || 0;
            if (!product || value === 0) { this.dom.priceDisplay.textContent = this.currentMode === 'weightToPrice' ? '₹0.00' : '0 g'; return; }
            const { finalPrice, finalWeight } = this.getCalculationDetails(product, value);
            this.dom.priceDisplay.textContent = this.currentMode === 'weightToPrice' ? `₹${finalPrice.toFixed(2)}` : `${finalWeight.toFixed(2)} g`;
        }
        
        populateProductSelect() { const selectedVal = this.dom.productSelect.value; this.dom.productSelect.innerHTML = this.products.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); if (this.products.length === 0) this.dom.productSelect.innerHTML = '<option>प्रोडक्ट जोड़ें</option>'; this.dom.productSelect.value = selectedVal || (this.products.length > 0 ? this.products[0].id : ''); }
        openAddProductModal() { document.getElementById('productForm').reset(); document.getElementById('productId').value = ''; this.dom.modals.product.querySelector('h2').textContent = 'नया प्रोडक्ट जोड़ें'; this.openModal(this.dom.modals.product); }
        handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const productData = { name: document.getElementById('productName').value, price: parseFloat(document.getElementById('productPrice').value), unit: parseInt(document.getElementById('productUnit').value), commission: parseFloat(document.getElementById('productCommission').value) || 0, commissionType: document.getElementById('commissionType').value };
            if (id) {
                const index = this.products.findIndex(p => p.id == id);
                if (index > -1) this.products[index] = { ...this.products[index], ...productData };
            } else {
                this.products.push({ id: this.nextProductId++, ...productData });
            }
            this.saveProducts(); this.populateProductSelect(); this.calculate(); this.closeModal(this.dom.modals.product);
        }
        openManageModal() { document.getElementById('productList').innerHTML = this.products.map(p => `<li><span>${p.name} (₹${p.price}/${p.unit}g)</span><span class="product-actions"><i class="material-icons-round edit-btn" data-id="${p.id}">edit</i><i class="material-icons-round delete-btn" data-id="${p.id}">delete</i></span></li>`).join('') || '<li>कोई प्रोडक्ट नहीं मिला।</li>'; this.openModal(this.dom.modals.manage); }
        handleProductListActions(e) {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;
            const productToEdit = this.products.find(p => p.id == id);
            if (!productToEdit) return;
            if (target.classList.contains('edit-btn')) {
                document.getElementById('productId').value = productToEdit.id;
                document.getElementById('productName').value = productToEdit.name;
                document.getElementById('productPrice').value = productToEdit.price;
                document.getElementById('productUnit').value = productToEdit.unit;
                document.getElementById('productCommission').value = productToEdit.commission;
                document.getElementById('commissionType').value = productToEdit.commissionType;
                this.dom.modals.product.querySelector('h2').textContent = 'प्रोडक्ट एडिट करें';
                this.closeModal(this.dom.modals.manage);
                this.openModal(this.dom.modals.product);
            } else if (target.classList.contains('delete-btn')) {
                if (confirm(`क्या आप वाकई '${productToEdit.name}' को हटाना चाहते हैं?`)) {
                    this.products = this.products.filter(p => p.id != id);
                    this.saveProducts(); this.populateProductSelect(); this.calculate();
                    this.openManageModal();
                }
            }
        }
        openStoreInfoModal(){ document.getElementById('inputStoreName').value = this.storeInfo.name; document.getElementById('inputStoreAddress').value = this.storeInfo.address; this.openModal(this.dom.modals.store); }
        
        getCalculationDetails(product, value) {
            let finalPrice, finalWeight, grossPrice, commissionAmount = 0;
            const pricePerGram = product.price / product.unit;
            if (this.currentMode === 'weightToPrice') {
                finalWeight = value; grossPrice = finalWeight * pricePerGram;
                if(product.commission) commissionAmount = product.commissionType === 'percent' ? grossPrice * (product.commission / 100) : product.commission;
                finalPrice = Math.max(0, grossPrice - commissionAmount);
            } else {
                finalPrice = value;
                grossPrice = finalPrice;
                if (product.commission > 0) grossPrice = product.commissionType === 'percent' ? finalPrice / (1 - product.commission / 100) : finalPrice + product.commission;
                finalWeight = grossPrice / pricePerGram;
                commissionAmount = grossPrice - finalPrice;
            }
            return { finalPrice, finalWeight, grossPrice, commissionAmount };
        }

        showBreakdown() {
            const product = this.products.find(p => p.id == this.dom.productSelect.value);
            const value = parseFloat(this.dom.mainInput.value) || 0;
            if (!product || value === 0) return alert("विवरण देखने के लिए कृपया कोई मान दर्ज करें।");
            const { finalPrice, finalWeight, grossPrice, commissionAmount } = this.getCalculationDetails(product, value);
            const breakdownDetailsEl = document.getElementById('breakdownDetails');
            breakdownDetailsEl.className = 'pos-style-view';
            breakdownDetailsEl.innerHTML = `
                <div><span>प्रोडक्ट:</span><span>${product.name}</span></div>
                <div><span>भाव:</span><span>₹${product.price}/${product.unit}g</span></div>
                <div><span>कुल वज़न:</span><span>${finalWeight.toFixed(2)} g</span></div>
                <div><span>बिना कमीशन के:</span><span>₹${grossPrice.toFixed(2)}</span></div>
                <div><span>कमीशन:</span><span>- ₹${commissionAmount.toFixed(2)}</span></div>
                <div><span>कुल कीमत:</span><span>₹${finalPrice.toFixed(2)}</span></div>
            `;
            this.openModal(this.dom.modals.breakdown);
        }
        
        openThemeModal() {
            const themeGrid = document.getElementById('themeGrid');
            themeGrid.innerHTML = Object.entries(this.themes).map(([name, theme]) => `<div class="theme-option" title="${name}" style="background: ${theme.color};" data-themeclass="${theme.class}"></div>`).join('');
            themeGrid.onclick = (e) => {
                if(e.target.classList.contains('theme-option')){
                    const themeClass = e.target.dataset.themeclass;
                    this.dom.body.className = themeClass;
                    localStorage.setItem('weighingTheme', themeClass);
                    this.closeModal(this.dom.modals.theme);
                }
            };
            this.openModal(this.dom.modals.theme);
        }

        printReceipt() {
            const product = this.products.find(p => p.id == this.dom.productSelect.value);
            const value = parseFloat(this.dom.mainInput.value) || 0;
            if (!product || value === 0) return alert("रसीद के लिए कृपया कोई मान दर्ज करें।");
            const { finalPrice, finalWeight, grossPrice, commissionAmount } = this.getCalculationDetails(product, value);
            
            const receiptEl = document.getElementById('receipt');
            const receiptHTML = `
                <div style="padding: 20px; background: #fff; color: #000; font-family: 'Courier New', monospace; width: 320px;">
                    <div style="font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 5px;">${this.storeInfo.name}</div>
                    <div style="text-align: center; font-size: 12px; margin-bottom: 10px;">${this.storeInfo.address}</div>
                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                    <div style="font-size: 12px;">Date: ${new Date().toLocaleString('hi-IN')}</div>
                    <div style="font-size: 12px;">Receipt#: ${Date.now() % 100000}</div>
                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #000;">
                        <thead><tr><th style="padding: 5px 0; text-align: left; border-bottom: 1px dashed #000;">Item/Wt</th><th style="padding: 5px 0; text-align: right; border-bottom: 1px dashed #000;">Price</th></tr></thead>
                        <tbody><tr>
                            <td style="padding: 3px 0;">${product.name} (${finalWeight.toFixed(2)} g)</td>
                            <td style="padding: 3px 0; text-align: right;">₹${grossPrice.toFixed(2)}</td>
                        </tr></tbody>
                    </table>
                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                    <table style="width: 100%; font-size: 12px; color: #000;">
                        <tr><td>Subtotal:</td><td style="text-align: right;">₹${grossPrice.toFixed(2)}</td></tr>
                        <tr><td>Commission:</td><td style="text-align: right;">-₹${commissionAmount.toFixed(2)}</td></tr>
                    </table>
                    <div style="border-top: 1px solid #000; margin: 8px 0;"></div>
                    <table style="width: 100%; font-size: 16px; font-weight: bold; color: #000;">
                        <tr><td>Total:</td><td style="text-align: right;">₹${finalPrice.toFixed(2)}</td></tr>
                    </table>
                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>
                    <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #000;">Thank you!</p>
                </div>`;
            receiptEl.innerHTML = receiptHTML;

            const elementToCapture = receiptEl.firstChild;
            receiptEl.style.display = 'block';
            html2canvas(elementToCapture, { scale: 4 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `receipt-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                receiptEl.style.display = 'none';
            });
        }
        
        importData() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data) && confirm('मौजूदा प्रोडक्ट्स को इम्पोर्टेड लिस्ट से बदलें?')) {
                            this.products = data; this.saveProducts(); this.init();
                            alert('प्रोडक्ट्स सफलतापूर्वक इम्पोर्ट हुए!');
                        } else alert('अमान्य फ़ाइल।');
                    } catch { alert('फ़ाइल पढ़ने में त्रुटि।'); }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        exportData() {
            if (!this.products.length) return alert("एक्सपोर्ट करने के लिए कोई प्रोडक्ट नहीं है।");
            const blob = new Blob([JSON.stringify(this.products, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `products_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }
    }
    new WeighingApp();
    </script>
</body>
</html>